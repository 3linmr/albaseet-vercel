# فاتورة مرتجع بيع نقداً - جديد
شاشة إنشاء فاتورة مرتجع بيع نقدية جديدة في النظام.

### 🧭 الموقع في النظام
**المبيعات → دورات البيع → دورة البيع المباشر → فاتورة مرتجع بيع نقداً → جديد**

### 🔹 الواجهة العلوية
- **العنوان**: فاتورة مرتجع بيع نقداً - جديد
- **الموقع الحالي**: موقع 1
- **المستخدم**: أحمد أيمن
- **خيارات اللغة**: English / العربية

### 🧰 الحقول الأساسية (تفاصيل المستند)
- **رقم السند** - رقم تلقائي أو يدوي للفاتورة المرتجعة (مثلاً: BR1)
- **تاريخ السند** - التاريخ الحالي تلقائياً (22/10/2025) مع إمكانية التعديل
- **مندوب المبيعات** - اختيار المندوب المرتبط بالعملية
- **المرجع** - رقم مرجع داخلي أو ملاحظة لربط الفاتورة الأصلية
- **اختر من فاتورة بيع نقداً** - اختيار الفاتورة الأصلية التي يتم إرجاعها جزئياً أو كلياً
- **العميل*** - تحديد العميل النقدي المرتبط بالعملية
- **اسم العميل النقدي** - الاسم الكامل للعميل (تعبئة يدوية أو تلقائية)
- **هاتف العميل** - رقم الاتصال بالعميل
- **عنوان العميل** - العنوان الذي تم تنفيذ البيع منه
- **رقم العميل الضريبي** - رقم التسجيل الضريبي للعميل (إن وجد)
- **حساب المدين** - الحساب المالي للعميل في الدليل المحاسبي
- **وصف السند بالعربية / بالإنجليزية** - وصف مخصص يظهر في التقارير والفواتير

### 📦 تفاصيل الأصناف المرتجعة (شبكة البيانات الأولى)
**الجدول الرئيسي يحتوي على تفاصيل كل صنف يتم إرجاعه:**

- **باركود** - رمز الباركود الخاص بالصنف
- **الرقم الداخلي** - رقم تعريفي داخلي في النظام
- **رقم الصنف** - رقم الصنف في قاعدة البيانات
- **الصنف** - اسم المنتج المرتجع
- **الوحدة** - وحدة القياس (علبة، قطعة، كرتون...)
- **الشد** - حجم التعبئة
- **الكمية السابقة** - الكمية الأصلية المباعة
- **الكمية المتاحة** - الكمية المتبقية في المخزون
- **الكمية** - الكمية المرتجعة فعلياً
- **سعر البيع** - السعر للوحدة الواحدة
- **الإجمالي** - القيمة الإجمالية قبل الخصم
- **نسبة الخصم / قيمة الخصم** - الخصم المطبق على الصنف
- **الإجمالي بعد خصم الصنف** - بعد تطبيق الخصم الفردي
- **نصيب الصنف من خصم المستند** - في حال وجود خصم عام على الفاتورة
- **الصافي قبل الضريبة** - قيمة الصنف قبل ضريبة القيمة المضافة
- **قيمة الضرائب الأخرى** - إن وُجدت ضرائب إضافية
- **المبلغ بعد الضرائب الأخرى** - الناتج بعد إضافة الضرائب الأخرى
- **نسبة ضريبة القيمة المضافة** - نسبة VAT (مثل 15%)
- **ضريبة القيمة المضافة** - قيمة الضريبة المحسوبة
- **الصافي** - القيمة النهائية للصنف بعد كل العمليات
- **تاريخ الصلاحية** - في حال كان الصنف له صلاحية
- **التشغيله** - رقم التشغيلة (Batch No)
- **مركز التكلفة** - المركز المرتبط بالمبيعات أو الإرجاع

**🔸 لا توجد بيانات افتراضية في البداية (الجدول يبدأ فارغاً)**

### 🔁 أزرار التحكم بالصنف
- **ارتجاع الكل** - إرجاع جميع الأصناف في الفاتورة الأصلية دفعة واحدة
- **ارتجاع المحدد** - إرجاع الأصناف التي تم اختيارها فقط

### 🧮 إجماليات الفاتورة (أسفل الجدول)
- **الإجمالي** - مجموع قيم الأصناف قبل أي خصومات
- **إجمالي الخصومات على الصنف** - مجموع الخصومات الفردية على كل صنف
- **نسبة الخصم على المستند** - نسبة الخصم العام على الفاتورة
- **قيمة الخصم على المستند** - القيمة المالية للخصم العام
- **الصافي قبل الضريبة** - المجموع بعد الخصومات وقبل الضرائب
- **ضرائب أخرى** - أي ضرائب غير ضريبة القيمة المضافة
- **المبلغ بعد الضرائب الأخرى** - ناتج الجمع بعد الضرائب الأخرى
- **ضريبة القيمة المضافة** - قيمة الـVAT الإجمالية
- **الصافي قبل الخصم الإضافي** - مجموع الفاتورة قبل الخصم النهائي
- **خصم إضافي** - خصم عام على الفاتورة بالكامل
- **الصافي** - القيمة النهائية للفاتورة بعد كل الخصومات والضرائب

### 💳 طرق الدفع
- **طرق الدفع المتاحة**: نقدي
- **المبلغ المدفوع**: يتم إدخاله يدوياً أو حسابه تلقائياً بناءً على المرتجع

### 🧾 سبب الارتجاع
- **سبب الارتجاع طبقاً لجدول هيئة الضرائب**: اختيار من قائمة جاهزة (مثلاً: خطأ في الفاتورة، بضاعة تالفة، طلب إلغاء، إلخ)

### 🧰 أزرار أسفل الصفحة
- **🗎 حفظ & جديد** - حفظ الفاتورة وإنشاء صفحة جديدة
- **🖨️ حفظ & طباعة & جديد** - حفظ، طباعة، وفتح فاتورة جديدة
- **🖨️ حفظ & طباعة & عودة** - حفظ، طباعة، ثم العودة لقائمة الفواتير
- **📂 حفظ & عودة** - حفظ فقط والرجوع للقائمة
- **🔁 تفريغ** - مسح البيانات الحالية
- **⬅️ عودة** - الرجوع إلى الصفحة السابقة

### ⚙️ إضافات وملاحظات
- **إرسال الفاتورة الإلكترونية الآن** - لتوليد ورفع الفاتورة إلكترونياً لهيئة الزكاة
- **المساعد الذكي** - يمكن فتحه أو إخفاؤه

### 🛻 تفاصيل الشحن
**تبويب تفاصيل الشحن يحتوي على الحقول التالية:**

#### 🧩 الحقول المتاحة في التبويب
- **عنوان الشحن** - يتم إدخال العنوان الذي سيتم استلام البضاعة المرتجعة منه
- **عنوان الفوترة** - العنوان الذي يُستخدم في طباعة الفاتورة أو الإشعارات (غالباً عنوان العميل في النظام)
- **نوع الشحن** - يحدد نوع عملية الشحن للمرتجع — الخيارات عادة تشمل:
  - استلام يدوي (من العميل مباشرة)
  - شركة شحن
  - توصيل داخلي من المندوب
- **تعليمات التوصيل** - ملاحظات إضافية توضح طريقة أو شروط استلام المرتجع، مثل: "يُستلم من بوابة المستودع"، "يرجى الاتصال قبل الوصول"
- **تاريخ الشحن** - تاريخ خروج أو استلام البضاعة المرتجعة من العميل — مبدئياً يعرض التاريخ الحالي (٢٢/١٠/٢٠٢٥) مع إمكانية التعديل
- **تاريخ التوصيل** - تاريخ تسليم البضاعة المرتجعة للمستودع أو الجهة المستقبِلة — أيضاً مضبوط افتراضياً على (٢٢/١٠/٢٠٢٥)
- **اسم السائق** - اسم السائق الذي قام بعملية النقل أو الاستلام
- **هاتف السائق** - رقم الهاتف الخاص بالسائق للتواصل
- **اسم العميل المسؤول** - الشخص الممثل للعميل الذي سلّم البضاعة المرتجعة
- **هاتف العميل المسؤول** - رقم هاتف هذا الشخص للتأكيد أو التواصل بشأن المرتجع

#### ⚙️ عناصر تحكم إضافية
- **زر "إرسال الفاتورة الإلكترونية الآن"** - لرفع المستند مباشرة إلى هيئة الزكاة والضريبة والجمارك بعد تعبئة بيانات الشحن

#### 🧰 أزرار الحفظ أسفل التبويب
- **حفظ & جديد**
- **حفظ & طباعة & جديد**
- **حفظ & طباعة & عودة**
- **حفظ & عودة**
- **تفريغ** (لإعادة تعيين الحقول)
- **عودة** (للرجوع للقائمة)

#### 💡 ملاحظات إضافية
- **كل الحقول في تبويب "تفاصيل الشحن" اختيارية** إلا إذا فُعّل خيار "إلزامي" من الإعدادات العامة للمبيعات
- **تظهر هذه التفاصيل لاحقًا في نسخة الطباعة الرسمية للفاتورة الإلكترونية** تحت قسم "بيانات الشحن والفوترة"
- **النظام يدعم التاريخ الهجري والميلادي** حسب الإعداد العام

### القيد المحاسبي (تبويب)
**شاشة القيد المحاسبي تحتوي على:**

#### جدول القيود المحاسبية
**أدوات الجدول:**
- **صف جديد** - زر مع سهم لأسفل
- **الخط** - أزرار + و - لإضافة/حذف الصفوف
- **سهم لأعلى** - أيقونة سهم

**أعمدة الجدول:**
- **أدوات** - عمود مع أيقونة دولار ($) لكل صف
- **الوصف** - مع أعمدة فرعية "وصف السند بالإنجليزية" و "وصف السند بالعربية"
- **المبلغ** - مع أعمدة فرعية "دائن (ريال)" و "مدين (ريال)"
- **الحساب** - مع أعمدة فرعية "الحساب" و "م" (رقم السطر)

**ملخص القيد:**
- **العدد**: 0
- **إجمالي الدائن**: 0.000
- **إجمالي المدين**: 0.000
- **حالة القيد**: قيد التحضير (مربع أحمر)

### ملاحظات (تبويب)
**شاشة الملاحظات تحتوي على:**

#### إضافة ملاحظة جديدة
- **معرف الملاحظة** - حقل نصي مع نص "اختر المعرف" وقائمة منسدلة
- **ملاحظة** - حقل نصي متعدد الأسطر
- **إضافة** - زر أزرق

#### سجل الملاحظات
**أدوات الجدول:**
- **الخط** - أزرار + و - لإضافة/حذف الصفوف

**أعمدة الجدول:**
- **المعرف** - حقل نصي مع أيقونة فلتر وعدسة مكبرة
- **قيمة الملاحظة** - حقل نصي مع أيقونة فلتر وعدسة مكبرة
- **ملاحظة** - حقل نصي مع أيقونة فلتر وعدسة مكبرة

### 🔧 مفاتيح الاختصار المتاحة
- **(F9) تنفيذ أمر**
- **(Shift + Delete) حذف**
- **(Esc) رجوع**
- **(F8) إضافة معرف جديد**

### المميزات الرئيسية
- **ربط بالفاتورة الأصلية**: اختيار الفاتورة الأصلية المراد إرجاعها
- **إدارة الأصناف المرتجعة**: تسجيل تفاصيل كل صنف مرتجع
- **حسابات مالية دقيقة**: حساب الضرائب والخصومات تلقائياً
- **أسباب الارتجاع**: تحديد سبب الارتجاع حسب معايير هيئة الضرائب
- **طرق دفع مرنة**: دعم طرق الدفع المختلفة
- **مفاتيح اختصار**: تسريع العمليات باستخدام المفاتيح

### التفاصيل التقنية
- **الربط الخلفي**: `Sales.API/Controllers/CashSalesReturnInvoicesController`
- **التحقق من البيانات**: فحص صحة البيانات قبل الحفظ
- **إدارة الحالة**: إدارة حالة فاتورة المرتجع
- **ربط العملاء**: ربط فواتير المرتجع بالعملاء ومندوبي المبيعات
- **الربط بالفاتورة الأصلية**: ربط المرتجع بفاتورة البيع الأصلية
- **إدارة المخزون**: تحديث أرصدة المخزن تلقائياً
- **الربط الضريبي**: ربط أسباب الارتجاع بجدول هيئة الضرائب

## فاتورة تصفية حجز
